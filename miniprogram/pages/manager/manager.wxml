<view class="container">
  <!-- WXS module for array helper (moved to top) -->
  <wxs module="utils">
    function includes(arr, val) {
      if (!arr) return false;
      // Use loose equality to handle potential string/number mismatches
      for (var i = 0; i < arr.length; i++) {
        if (arr[i] == val) return true;
      }
      return false;
    }
    module.exports = { includes: includes };
  </wxs>

  <!-- Tabs -->
  <view class="tabs">
    <view 
      wx:for="{{tabs}}" 
      wx:key="id" 
      class="tab-item {{activeTab === item.id ? 'active' : ''}}"
      bindtap="switchTab"
      data-id="{{item.id}}"
    >
      {{item.name}}
    </view>
  </view>

  <!-- Content Area -->
  <scroll-view scroll-y class="content-scroll" bindscrolltolower="onReachBottom">
    
    <!-- 1. Users Management -->
    <view wx:if="{{activeTab === 'users'}}" class="module-section">
      <view class="header-row column">
        <view class="row-between">
          <text class="section-title">用户列表 ({{users.length}})</text>
        </view>
        <input class="search-input" placeholder="搜索姓名/部门/电话/角色..." bindconfirm="onSearchUser" bindinput="onSearchUserInput" value="{{userSearch}}"/>
      </view>
      <view class="card-list">
        <view class="card-item" wx:for="{{users}}" wx:key="_id">
          <view class="card-main">
            <view class="card-row">
              <text class="card-title">{{item.name || '未命名'}}</text>
              <text class="card-tag">{{item.department || '无部门'}}</text>
            </view>
            <view class="card-row">
              <text class="card-sub">{{item.phoneNumber}}</text>
              <text class="card-sub">{{item.roleName || '无角色'}}</text>
            </view>
          </view>
          <view class="card-actions">
            <view class="btn btn-primary" bindtap="openUserEdit" data-item="{{item}}">编辑</view>
            <view class="btn btn-danger" bindtap="deleteUser" data-id="{{item._id}}">删除</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 2. Pending Users (Audit) -->
    <view wx:if="{{activeTab === 'audit'}}" class="module-section">
      <view class="header-row">
        <text class="section-title">待审核 ({{pendingUsers.length}})</text>
      </view>
      <view class="card-list">
        <block wx:if="{{pendingUsers.length === 0}}">
          <view class="empty-state">暂无待审核申请</view>
        </block>
        <view class="card-item" wx:for="{{pendingUsers}}" wx:key="_id">
          <view class="card-main">
            <view class="card-title">{{item.name}}</view>
            <view class="card-sub">{{item.phoneNumber}} - {{item.department}}</view>
            <view class="card-time">申请时间: {{item.createdAtStr}}</view>
          </view>
          <view class="card-actions">
            <view class="btn btn-success" bindtap="approveUser" data-id="{{item._id}}">通过</view>
            <view class="btn btn-danger" bindtap="rejectUser" data-id="{{item._id}}">拒绝</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 3. Menus Management -->
    <view wx:if="{{activeTab === 'menus'}}" class="module-section">
      <view class="header-row">
        <text class="section-title">菜单管理</text>
        <view class="btn btn-add" bindtap="openMenuAdd">新增菜单</view>
      </view>
      <view class="card-list">
        <view class="card-item" wx:for="{{menus}}" wx:key="_id">
          <image class="card-icon" src="{{item.icon}}" mode="aspectFit"></image>
          <view class="card-main">
            <view class="card-row">
              <text class="card-title">{{item.name}} (ID: {{item.menuId}})</text>
              <text class="card-tag {{item.isActive ? 'tag-green' : 'tag-gray'}}">{{item.isActive ? '启用' : '禁用'}}</text>
            </view>
            <view class="card-sub">{{item.page}}</view>
            <view class="card-sub">排序: {{item.sortOrder}}</view>
          </view>
          <view class="card-actions vertical">
            <view class="btn btn-primary" bindtap="openMenuEdit" data-item="{{item}}">编辑</view>
            <view class="btn btn-danger" bindtap="deleteMenu" data-id="{{item._id}}">删除</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 4. Roles Management -->
    <view wx:if="{{activeTab === 'roles'}}" class="module-section">
      <view class="header-row">
        <text class="section-title">角色管理</text>
        <view class="btn btn-add" bindtap="openRoleAdd">新增角色</view>
      </view>
       <view class="card-list">
        <view class="card-item" wx:for="{{roles}}" wx:key="_id">
          <view class="card-main">
             <view class="card-row">
              <text class="card-title">{{item.name}} (ID: {{item.roleId}})</text>
            </view>
             <view class="card-sub">{{item.description || '无描述'}}</view>
          </view>
           <view class="card-actions">
            <view class="btn btn-primary" bindtap="openRoleEdit" data-item="{{item}}">编辑</view>
            <view class="btn btn-danger" bindtap="deleteRole" data-id="{{item._id}}">删除</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 5. Telbook Management -->
    <view wx:if="{{activeTab === 'telbook'}}" class="module-section">
      <view class="header-row column">
        <view class="row-between">
           <text class="section-title">电话簿</text>
           <view class="btn btn-add" bindtap="openTelbookAdd">新增</view>
        </view>
        <input class="search-input" placeholder="搜索名称..." bindconfirm="onSearchTelbook" bindinput="onSearchInput" value="{{telbookSearch}}"/>
      </view>
      <view class="card-list">
        <view class="card-item" wx:for="{{telbooks}}" wx:key="_id">
          <view class="card-main">
             <view class="card-title">{{item.name}}</view>
             <view class="card-sub">{{item.remark}}</view>
             <view class="card-row mt-10">
               <text class="phone-item">外: {{item.outPhone}}</text>
               <text class="phone-item">内: {{item.inPhone}}</text>
             </view>
          </view>
           <view class="card-actions">
            <view class="btn btn-primary" bindtap="openTelbookEdit" data-item="{{item}}">编辑</view>
            <view class="btn btn-danger" bindtap="deleteTelbook" data-id="{{item._id}}">删除</view>
          </view>
        </view>
      </view>
    </view>

  </scroll-view>

  <!-- Modals -->
  
  <!-- Modal Overlay (Common for all modals) -->
  <view class="modal-overlay" wx:if="{{showUserModal || showMenuModal || showRoleModal || showTelbookModal}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="closeAllModals"></view>
    
    <!-- User Modal Content -->
    <view class="modal-container {{showUserModal ? 'show' : ''}}" wx:if="{{showUserModal}}">
      <view class="modal-header">编辑用户</view>
        <view class="form-group">
          <text class="label">姓名</text>
          <input class="input" value="{{formData.name}}" data-field="name" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">部门</text>
          <input class="input" value="{{formData.department}}" data-field="department" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">角色ID (数字)</text>
          <input class="input" type="number" value="{{formData.roleId}}" data-field="roleId" bindinput="handleInput" />
        </view>
        <button class="submit-btn" bindtap="submitUser">保存</button>
    </view>

    <!-- Menu Modal Content -->
    <view class="modal-container {{showMenuModal ? 'show' : ''}}" wx:if="{{showMenuModal}}">
      <view class="modal-header">{{isEdit ? '编辑' : '新增'}}菜单</view>
      <scroll-view scroll-y style="max-height: 70vh;">
        <view class="form-group" wx:if="{{isEdit}}">
          <text class="label">菜单ID (数字/唯一)</text>
          <input class="input" type="number" value="{{formData.menuId}}" data-field="menuId" bindinput="handleInput" disabled="{{true}}" />
        </view>
        <view class="form-group">
          <text class="label">名称</text>
          <input class="input" value="{{formData.name}}" data-field="name" bindinput="handleInput" />
        </view>
         <view class="form-group">
          <text class="label">Icon地址</text>
          <input class="input" value="{{formData.icon}}" data-field="icon" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">页面路径/AppID</text>
          <input class="input" value="{{formData.page}}" data-field="page" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">类型</text>
          <picker bindchange="handleTypeChange" value="{{typeIndex}}" range="{{typeOptions}}">
            <view class="picker-view input">
               {{formData.type || 'page'}} 
            </view>
          </picker>
        </view>
        <view class="form-group">
          <text class="label">排序 (数字)</text>
          <input class="input" type="number" value="{{formData.sortOrder}}" data-field="sortOrder" bindinput="handleInput" />
        </view>
        <view class="form-group row">
           <text class="label">启用</text>
           <switch checked="{{formData.isActive}}" data-field="isActive" bindchange="handleSwitch" />
        </view>
        <button class="submit-btn" bindtap="submitMenu">保存</button>
      </scroll-view>
    </view>

    <!-- Role Modal Content -->
    <view class="modal-container {{showRoleModal ? 'show' : ''}}" wx:if="{{showRoleModal}}">
      <view class="modal-header">{{isEdit ? '编辑' : '新增'}}角色</view>
      <scroll-view scroll-y style="max-height: 70vh;">
        <view class="form-group" wx:if="{{isEdit}}">
          <text class="label">角色ID (数字)</text>
          <input class="input" type="number" value="{{formData.roleId}}" data-field="roleId" bindinput="handleInput" disabled="{{true}}" />
        </view>
        <view class="form-group">
          <text class="label">名称</text>
          <input class="input" value="{{formData.name}}" data-field="name" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">描述</text>
          <input class="input" value="{{formData.description}}" data-field="description" bindinput="handleInput" />
        </view>
        
        <!-- Menu Selection Checkboxes -->
        <view class="form-group">
          <text class="label">权限菜单</text>
          <checkbox-group bindchange="handleRoleMenuChange">
            <view class="checkbox-list">
              <label class="checkbox-item" wx:for="{{menus}}" wx:key="menuId">
                <checkbox value="{{item.menuId}}" checked="{{utils.includes(formData.menuIds, item.menuId)}}" />
                <text>{{item.name}} (ID:{{item.menuId}})</text>
              </label>
            </view>
          </checkbox-group>
        </view>

        <button class="submit-btn" bindtap="submitRole">保存</button>
      </scroll-view>
    </view>

    <!-- Telbook Modal Content -->
    <view class="modal-container {{showTelbookModal ? 'show' : ''}}" wx:if="{{showTelbookModal}}">
      <view class="modal-header">{{isEdit ? '编辑' : '新增'}}电话簿</view>
      <scroll-view scroll-y style="max-height: 70vh;">
        <view class="form-group">
          <text class="label">部门/名称</text>
          <input class="input" value="{{formData.name}}" data-field="name" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">备注/位置</text>
          <input class="input" value="{{formData.remark}}" data-field="remark" bindinput="handleInput" />
        </view>
         <view class="form-group">
          <text class="label">外线</text>
          <input class="input" value="{{formData.outPhone}}" data-field="outPhone" bindinput="handleInput" />
        </view>
        <view class="form-group">
          <text class="label">内线</text>
          <input class="input" value="{{formData.inPhone}}" data-field="inPhone" bindinput="handleInput" />
        </view>
        <button class="submit-btn" bindtap="submitTelbook">保存</button>
      </scroll-view>
    </view>
  </view>
</view>
# 更新日志 (Changelog)

本文档记录项目的所有重要更新和变更。

---

## [1.1.0] - 2026-01-26

### 🔒 安全增强

#### 后端权限系统重构
对后端权限验证系统进行全面升级，实现基于角色和菜单的细粒度权限控制。

**核心改进：**
- ✅ **统一权限验证**：创建 `lib/auth.ts` 认证库，提供 `requireAuth`、`requirePermission` 等标准验证函数
- ✅ **基于菜单的权限控制**：实现 token → user → role → menuIds 的完整权限验证链
- ✅ **数据脱敏**：所有用户接口返回数据已移除敏感字段（token、openid）
- ✅ **自我操作防护**：用户无法修改自己的角色权限、无法删除自己的账号、系统保护最后一个管理员
- ✅ **批量操作限制**：为批量导入和删除操作添加数量上限，防止误操作

**权限分级：**
- 📌 menuId=0 (系统管理)：用户管理、角色管理、菜单管理、审核管理
- 📌 menuId=1 (系统维护)：电话簿增删改查
- 📌 menuId=10 (电话簿)：电话簿查看

**涉及模块：**
- `convex/lib/auth.ts` - 新增认证授权工具库
- `convex/manager.ts` - 18个管理接口权限升级
- `convex/telbook.ts` - 6个电话簿接口权限升级
- `convex/banners.ts` - 4个轮播图管理接口权限升级
- `convex/registration.ts` - 3个注册审核接口权限升级
- `convex/auth.ts` - 用户数据脱敏和批量导入权限控制

### 🛠️ 错误处理优化

#### HTTP 路由统一错误处理
为所有 HTTP 路由添加统一的错误处理机制，确保后端错误信息能够正确传递到前端。

**改进内容：**
- ✅ **统一错误响应格式**：所有错误返回 `{ success: false, message: "具体错误信息" }` 格式
- ✅ **智能状态码**：根据错误类型自动返回 401（认证失败）、403（权限不足）、500（服务器错误）
- ✅ **错误信息传递**：后端业务逻辑错误（如"不能修改自己的角色权限"）完整传递到前端
- ✅ **代码简化**：移除冗余 try-catch 块，统一通过中间件处理错误

**涉及文件：**
- `convex/http.ts` - 添加 `withErrorHandling` 包装函数，应用到所有33个路由

### 🔍 前端兼容性

- ✅ **零修改适配**：前端无需任何修改，所有接口通过 HTTP 路由层自动适配
- ✅ **认证方式**：前端通过 `auth: true` 参数自动在 Authorization header 中发送 token
- ✅ **错误显示**：前端可直接读取响应中的 `success` 和 `message` 字段显示错误提示

---

## [1.0.1] - 2026-01-25

### ✨ 新增功能

#### 注册页面用户服务协议及隐私政策

为符合用户隐私保护相关法规要求，在注册页面新增用户服务协议及隐私政策功能。

**功能特点：**
- 📋 **协议勾选框**：用户必须勾选同意协议后才能提交注册申请
- 📜 **用户服务协议**：点击链接可查看完整的用户服务协议内容
- 🔐 **隐私政策**：点击链接可查看完整的隐私政策内容
- 🔒 **隐私声明提示**：明确告知用户"您的手机号仅用于身份验证，我们将严格保护您的隐私"
- 🚫 **按钮状态控制**：未同意协议时，提交按钮处于禁用状态

**修改文件：**
- `miniprogram/pages/register/register.wxml` - 添加协议勾选UI组件和隐私声明
- `miniprogram/pages/register/register.js` - 添加协议同意状态管理和查看协议的方法
- `miniprogram/pages/register/register.wxss` - 添加协议区域样式

**技术实现：**
1. 新增 `agreedToTerms` 状态变量，记录用户是否同意协议
2. 新增 `toggleAgreement()` 方法，切换勾选状态
3. 新增 `viewUserAgreement()` 方法，弹窗显示用户服务协议
4. 新增 `viewPrivacyPolicy()` 方法，弹窗显示隐私政策
5. 在 `handleSubmit()` 中增加协议同意验证
6. 注册按钮根据 `agreedToTerms` 状态动态控制 disabled 属性

---

## [1.0.0] - 初始版本

### 🎉 首次发布

- 基础功能上线
